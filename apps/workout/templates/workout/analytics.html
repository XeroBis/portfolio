{% load static %}
{% load i18n %}
{% load custom_filters %}

{% include "home/head.html" %}

<body data-lang="{{ lang }}">
    {% include "home/header.html" %}

    <div class="container_analytics">

        <!-- Navigation Tabs -->
        <div class="analytics-tabs">
            <button class="tab-button active" data-tab="calendar">{% trans "Calendar" %}</button>
            <button class="tab-button" data-tab="dashboard">{% trans "Dashboard" %}</button>
            <button class="tab-button" data-tab="records">{% trans "Personal Records" %}</button>
        </div>

        <!-- Calendar View Section -->
        <div class="analytics-section active" id="calendar-section">
            <div class="year-navigation">
                <button class="year-nav-btn" id="prev-year" title="{% trans 'Previous year' %}" data-has-data="{% if has_prev_year_data %}true{% else %}false{% endif %}">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <h2><span id="current-year">{{ current_year }}</span></h2>
                <button class="year-nav-btn" id="next-year" title="{% trans 'Next year' %}" data-has-data="{% if has_next_year_data %}true{% else %}false{% endif %}">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="calendar-grid">
                {% for month in months %}
                <div class="calendar-month {% if month.is_current %}current-month{% endif %}">
                    <h3>{{ month.name }}</h3>
                    <div class="calendar-weekdays">
                        <div class="weekday">{% trans "M" %}</div>
                        <div class="weekday">{% trans "T" %}</div>
                        <div class="weekday">{% trans "W" %}</div>
                        <div class="weekday">{% trans "Th" %}</div>
                        <div class="weekday">{% trans "F" %}</div>
                        <div class="weekday">{% trans "Sa" %}</div>
                        <div class="weekday">{% trans "Su" %}</div>
                    </div>
                    <div class="calendar-days">
                        {% for _ in "x"|rjust:month.start_weekday %}
                        <div class="calendar-day empty"></div>
                        {% endfor %}
                        {% for day in "x"|rjust:month.num_days %}
                        {% with day_num=forloop.counter %}
                        {% with workout=month.workout_days|get_item:day_num %}
                        <div class="calendar-day {% if workout %}has-workout{% endif %}"
                             {% if workout %}data-workout-type="{{ workout.type }}" data-workout-id="{{ workout.id }}" title="{{ workout.type }}"{% endif %}>
                            {{ day_num }}
                        </div>
                        {% endwith %}
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="analytics-section" id="dashboard-section">
            <div class="date-filter-container">
                <div class="date-filter">
                    <div class="quick-select-section">
                        <span class="quick-select-label">{% trans "Quick Select" %}:</span>
                        <div class="quick-select-buttons">
                            <button class="quick-select-btn" data-range="7days">{% trans "Last 7 Days" %}</button>
                            <button class="quick-select-btn" data-range="1month">{% trans "Last Month" %}</button>
                            <button class="quick-select-btn" data-range="3months">{% trans "Last 3 Months" %}</button>
                            <button class="quick-select-btn" data-range="6months">{% trans "Last 6 Months" %}</button>
                            <button class="quick-select-btn" data-range="1year">{% trans "Last Year" %}</button>
                            <button class="quick-select-btn" data-range="ytd">{% trans "Year to Date" %}</button>
                        </div>
                    </div>

                    <div class="date-inputs-section">
                        <label for="start-date">{% trans "Start Date" %}:</label>
                        <input type="date" id="start-date" name="start_date" value="{{ start_date|default:'' }}">

                        <label for="end-date">{% trans "End Date" %}:</label>
                        <input type="date" id="end-date" name="end_date" value="{{ end_date|default:'' }}">
                    </div>

                    <div class="filter-actions">
                        <button id="apply-filter" class="filter-btn">{% trans "Apply Filter" %}</button>
                        <button id="reset-filter" class="filter-btn reset-btn">{% trans "Reset" %}</button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ total_workouts }}</div>
                    <div class="stat-label">{% trans "Total Workouts" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_exercises }}</div>
                    <div class="stat-label">{% trans "Total Exercises" %}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_volume|floatformat:0 }} kg</div>
                    <div class="stat-label">{% trans "Total Volume" %}</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-container">
                <!-- Weekly Trend Chart -->
                <div class="chart-card">
                    <h3>{% trans "Weekly Workout Trend" %} </h3>
                    <canvas id="weeklyTrendChart"></canvas>
                </div>

                <!-- Workouts by Type Chart -->
                <div class="chart-card">
                    <h3>{% trans "Workouts by Type" %}</h3>
                    <canvas id="workoutTypeChart"></canvas>
                </div>

                <!-- Top Exercises -->
                <div class="chart-card">
                    <h3>{% trans "Top 10 Exercises" %}</h3>
                    <canvas id="topExercisesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="analytics-section" id="records-section">

            {% if personal_records %}
            <div class="records-grid">
                {% for pr in personal_records %}
                <div class="record-card">
                    <div class="record-exercise">{{ pr.exercise.name }}</div>
                    <div class="record-type">{{ pr.display_name }}</div>
                    <div class="record-value">{{ pr.value|floatformat:0 }}{% if pr.record_type == 'max_weight' %} kg{% elif pr.record_type == 'max_volume' %} kg{% else %} reps{% endif %}</div>
                    <div class="record-date">{{ pr.date_achieved|date:"M d, Y" }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>{% trans "No personal records yet. Keep training!" %}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const weeklyWorkouts = {{ weekly_workouts|safe }};
        const workoutsByType = {{ workouts_by_type|safe }};
        const topExercises = {{ top_exercises|safe }};

        // Translations for chart labels
        const chartTranslations = {
            workoutsPerWeek: "{% trans 'Workouts per Week' %}",
            timesPerformed: "{% trans 'Times Performed' %}",
            weekdays: [
                "{% trans 'M' %}",
                "{% trans 'T' %}",
                "{% trans 'W' %}",
                "{% trans 'Th' %}",
                "{% trans 'F' %}",
                "{% trans 'Sa' %}",
                "{% trans 'Su' %}"
            ]
        };
    </script>
    <script src="{% static 'workout/js/analytics.js' %}"></script>

</body>
</html>
